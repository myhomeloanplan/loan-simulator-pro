<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä½å®…ãƒ­ãƒ¼ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆcompact +/âˆ’ãƒ»ï¼…è¡¨ç¤ºãƒ»ä¸‡å††ï¼‰</title>

  <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-dragdata@2.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <style>
/* ---------- ã‚«ãƒ©ãƒ¼ãƒ†ãƒ¼ãƒå¤‰æ•° ---------- */
:root{
  --navy:#0e2a47; --teal:#10939a; --teal-2:#0c7e86;
  --yellow:#ffbf3a; --yellow-2:#ffe28f; --bg:#f7fafc; --card:#ffffff;
  --muted:#5f6f84; --ring:rgba(16,147,154,.25); --line:#e6edf5;
  --coral:#ff4d6d; --coral-2:#ff6b81;
}

/* ---------- åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ---------- */
*{box-sizing:border-box}
body {
  font-family:
  'Noto Sans JP',                /* ç¬¬ä¸€å€™è£œï¼šGoogle Fonts æ—¥æœ¬èª */
    'Hiragino Kaku Gothic ProN',   /* macOS æ—¥æœ¬èªã‚´ã‚·ãƒƒã‚¯ */
    'BIZ UDPGothic',               /* Windows10ä»¥é™ æ—¥æœ¬èªã‚´ã‚·ãƒƒã‚¯ */
    'Yu Gothic',                   /* Windows æ—¥æœ¬èªã‚´ã‚·ãƒƒã‚¯ï¼ˆæ—§ï¼‰ */
    system-ui,                     /* OSæ¨™æº–UIãƒ•ã‚©ãƒ³ãƒˆ */
    -apple-system,                  /* Mac/iOSæ¨™æº–UIãƒ•ã‚©ãƒ³ãƒˆï¼ˆSF Proï¼‰ */
    Segoe UI,                       /* Windowsæ¨™æº–UIãƒ•ã‚©ãƒ³ãƒˆ */
    Roboto,                         /* Androidæ¨™æº–UIãƒ•ã‚©ãƒ³ãƒˆ */
    sans-serif;                     /* æœ€çµ‚ fallback */
  padding: 20px;
  background: var(--bg);
  max-width: 1100px;
  margin: auto;
  font-size: 18px;
  color: #102a43;
  background-image:
    radial-gradient(ellipse at 10% -20%, rgba(255, 216, 97, .18), transparent 45%),
    radial-gradient(ellipse at 110% 10%, rgba(25, 183, 181, .08), transparent 40%);
}

/* ---------- ã‚¿ã‚¤ãƒˆãƒ« ---------- */
.title-wrap{ text-align:center; margin:6px 0 10px;}
.subtitle{
  display:inline-block;
  margin-bottom:10px;
  font-weight:900;
  color:#0b4b77; /* å°‘ã—æ˜ã‚‹ã‚ */
  letter-spacing:.08em;
}
.subtitle::before{ content:"ï¼¼ "; } .subtitle::after{ content:" ï¼"; }
.title{ margin:0; color:var(--navy); font-weight:900; letter-spacing:.02em; font-size:clamp(22px,4.5vw,32px);}

/* ---------- ã‚«ãƒ¼ãƒ‰ ---------- */
.card{ background:var(--card); border-radius:16px; padding:18px; margin-top:16px; box-shadow:0 8px 24px rgba(15,48,87,.08); border:1px solid #eef3f9;}
.panel-title{ display:flex; align-items:center; gap:.5rem; margin:-6px 0 14px; font-weight:900; color:#navy;
  background:linear-gradient(90deg,var(--yellow),var(--yellow-2)); padding:.45rem .9rem; border-radius:999px; border:1px solid rgba(0,0,0,.06);
  box-shadow:0 4px 0 rgba(15,48,87,.08); font-size:18px; width:fit-content; white-space:nowrap;}
.panel-title .chip{ display:inline-flex; align-items:center; justify-content:center; width:22px; height:22px; border-radius:999px;
  background:linear-gradient(135deg,var(--teal),var(--teal-2)); color:#fff; font-weight:900; font-size:.9rem;}
/* çµæœã‚’ä¿å­˜ãƒ»æ¯”è¼ƒå°‚ç”¨ã®ä½™ç™½ */
.panel-title-save {
  margin-top: 16px; /* ä¸Šã«ã‚†ã¨ã‚Šã‚’è¿½åŠ  */
}
    
/* ---------- ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦‹å‡ºã— ---------- */
.section-title{ font-weight:900; font-size:16px; color:var(--navy); margin:18px 0 8px; padding:.35rem .7rem;
  background:repeating-linear-gradient(-45deg, rgba(255,216,97,.35) 0 6px, rgba(255,216,97,.22) 6px 12px);
  border-radius:8px; display:block; width:fit-content; white-space:nowrap; }

/* ---------- å…¥åŠ›ï¼ˆå…±é€šï¼‰ ---------- */
.range-labels{
  display:flex;
  justify-content:space-between;
  font-size:.9rem;
  color:var(--muted);
  margin:2px 0 0;
}
.inline-group{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top:6px;}
input[type="number"],input[type="text"],input[type="range"],select{
  padding:.7rem .8rem; font-size:1rem; width:100%; border-radius:12px; border:1px solid #dfe8f2; background:#fff;
  transition: box-shadow .15s ease, border-color .15s ease;
}
input[type="number"]:focus,input[type="text"]:focus,select:focus{ outline:none; border-color:var(--teal-2); box-shadow:0 0 0 4px var(--ring);}
input[type="range"]{ accent-color:var(--teal-2); }

/* ---------- ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®ãƒ•ã‚©ãƒ³ãƒˆã‚’çµ±ä¸€ï¼ˆå¤ã„ã‚´ã‚·ãƒƒã‚¯å¯¾ç­–ï¼‰ ---------- */
label,
.inline-group label,
select,
option {
  font-family: 'Noto Sans JP', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'Meiryo', 'BIZ UDPGothic', system-ui, sans-serif;
  font-weight: 500; /* Thinãªã©æ¥µç´°ã‚’é¿ã‘ã€ä¸­ãã‚‰ã„ã®å¤ªã•ã«å›ºå®š */
  font-size: 1rem;  /* å¿…è¦ãªã‚‰çµ±ä¸€ã€‚ä¸è¦ãªã‚‰ã“ã®è¡Œã¯æ¶ˆã—ã¦OK */
} 
    
/* ---------- ãƒœã‚¿ãƒ³ ---------- */
.actions{display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:12px; margin-top:12px;}
.btn{ appearance:none; -webkit-appearance:none; border:none; cursor:pointer; font-weight:900; letter-spacing:.02em;
  padding:1rem; border-radius:12px; transition: transform .06s ease, box-shadow .2s ease, filter .2s ease;
  font-size: calc(1rem + 2pt); }
.btn:active{ transform: translateY(1px); }
.btn-primary{ color:#fff; background:linear-gradient(135deg,var(--coral),var(--coral-2));
  border:1px solid rgba(0,0,0,.12); box-shadow:0 10px 22px rgba(255,77,109,.35); }
.btn-ghost{ background:linear-gradient(135deg,#bfe8ea,#8fdde0); color:#083b40; border:1px solid #6fd0d3; box-shadow:0 4px 10px rgba(13,126,134,.18);}

/* ---------- KPI ---------- */
.kpi{ display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:10px; margin-top:12px;}
.kpi .tile{ background:#fff; border:1px dashed #d9e6f3; border-radius:12px; padding:14px;}
.kpi .label{ font-size:.9rem; color:#3a5066;} .kpi .value{ font-weight:900; font-size:1.3rem; margin-top:4px; color:#102a43;}
#result{ white-space: pre-line; font-size:1rem; background:#fffef5; border:1px dashed #ffe28d; border-radius:10px; padding:10px;}

/* ---------- ãƒ†ãƒ¼ãƒ–ãƒ« ---------- */
table{ width:100%; border-collapse:collapse; margin-top:18px; font-size:.95rem;}
th,td{ border:1px solid var(--line); padding:.6rem; text-align:right;}
th{ background:#f2fbfc; color:#0b4a4f; font-weight:800;}

/* ---------- ã‚°ãƒ©ãƒ• ---------- */
.chart-block{ margin-top:14px; }
.chart-title{ font-size:16px; font-weight:800; color:var(--navy); margin:6px 4px; }
.chart-wrap{ width:100%; height:300px; background:linear-gradient(#fff,#fff) padding-box,
    repeating-linear-gradient(0deg, #f2f7fb 0 28px, #e9f1f8 28px 29px) border-box;
  border:1px solid #dfe8f2; border-radius:12px; padding:10px; overflow:hidden;}
.chart-wrap>canvas{ display:block; width:100% !important; height:100% !important;}
@media (max-width:640px){ .chart-wrap{ height:170px; } }

/* ---------- åŠå¹´ã”ã¨ã®é‡‘åˆ©å…¥åŠ›è¡Œ ---------- */
.rate-input-row{ display:flex; align-items:center; gap:10px; margin-top:8px;}
.rate-input-row span{ width:20%; font-size:.95rem; color:var(--muted);} 
.rate-input-row input{ width:35%; }
    
/* åŠå¹´å…¥åŠ›ã®è¦‹å‡ºã—è¡Œï¼ˆå‰åŠ/å¾ŒåŠï¼‰ */
.rate-input-head{
  display:flex;
  align-items:flex-end;
  gap:10px;
  margin:8px 0 6px;            /* ä¸Šä¸‹ã®ä½™ç™½ã¯ãŠå¥½ã¿ã§ */
}

/* å¹´ã®ãƒ€ãƒŸãƒ¼åˆ—ï¼ˆå·¦ç«¯ã®å¹´ãƒ©ãƒ™ãƒ«ã¨å¹…ã‚’åˆã‚ã›ã‚‹ï¼‰ */
.rate-input-head .col-year{
  width:20%;                    /* .rate-input-row span ã¨åŒã˜ */
}

/* å‰åŠ/å¾ŒåŠ è¦‹å‡ºã— */
.rate-input-head .col-half{
  width:35%;                    /* .rate-input-row input ã¨åŒã˜ */
  text-align:center;
  font-weight:800;
  color:#102a43;
  font-size:.95rem;
  letter-spacing:.02em;
}

/* ï¼ˆä»»æ„ï¼‰ã‚¹ãƒãƒ›ã§ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’éš ã™ */
@media (max-width: 640px){
  .rate-input-head{ display:none; }
}

/* =========================================================
   é‡‘åˆ©ä¸€æ‹¬å…¥åŠ›ãƒ„ãƒ¼ãƒ«ãƒãƒ¼
   ========================================================= */
.rate-toolbar{
  display:grid;
  grid-template-columns: auto 1fr auto;
  gap:10px;
  align-items:center;
  margin-top:8px;
  width:100%;
}

.rate-field{
  display:grid;
  grid-template-columns: 36px minmax(60px,84px) 18px 36px;
  align-items:center;
  gap:4px;
  background:#fff;
  border:1px solid #dfe8f2;
  border-radius:12px;
  padding:6px 8px;
  width:max-content;
  max-width:100%;
}

.icon-btn{
  -webkit-appearance:none; appearance:none;
  width:36px; height:36px; border:none; background:#e9f7f8; color:#0c7e86; border-radius:10px;
  display:inline-flex; align-items:center; justify-content:center; font-size:20px; font-weight:900;
  box-shadow: inset 0 -2px 0 rgba(0,0,0,.05);
}
.icon-btn:active{ transform:translateY(1px); }

.rate-input{
  width:84px;
  text-align:right;
  border:none;
  outline:none;
  font-weight:800;
  font-size:1rem;
  padding:.4rem .2rem .4rem .2rem;
  border-radius:8px;
  background:transparent;
}

.rate-suffix{ font-weight:800; color:#0c7e86; text-align:center; user-select:none; }

/* â–¼ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ */
.scope-field select{
  -webkit-appearance:none; appearance:none;
  min-width:9.5em;
  height:44px;
  padding:0 .7rem;
  padding-right:2em;
  border-radius:12px;
  border:1px solid #dfe8f2;
  background:#fff url("data:image/svg+xml,%3Csvg fill='%230c7e86' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E") no-repeat right 0.6em center;
  background-size:1em;
  font-size:1rem;
  font-weight:700;
  cursor:pointer;
}

.btn-compact{
  -webkit-appearance:none; appearance:none;
  color:#fff;
  background:linear-gradient(135deg,#0c7e86,#10939a);
  border:1px solid rgba(0,0,0,.08);
  box-shadow:0 8px 18px rgba(12,126,134,.28);
  padding:.5rem .9rem;
  font-size:0.95rem;
  border-radius:10px;
  display:inline-flex;
  gap:.4rem;
  align-items:center;
  font-weight:900;
  white-space:nowrap;
}
.btn-compact:hover{ filter:brightness(1.05); }
.btn-compact:active{ transform:translateY(1px); }

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
@media (max-width: 640px){
  .rate-toolbar{ grid-template-columns: auto 1fr; gap:8px; }
  .btn-compact{ grid-column: 1 / -1; width:100%; justify-content:center; padding:.55rem .9rem; font-size:.95rem; }
  .rate-field{ grid-template-columns: 32px minmax(52px,72px) 16px 32px; padding:4px 6px; }
  .icon-btn{ width:32px; height:32px; font-size:18px; }
  .rate-input{ width:72px; font-size:.95rem; padding:.3rem .18rem .3rem .14rem; }
  .rate-suffix{ font-size:.95rem; }
  .scope-field select{ min-width:8.2em; height:40px; padding:0 .6rem; padding-right:2em; }
}

@media (min-width: 768px){
  .rate-field{ height:44px; padding:0 8px; }
  .scope-field select{ height:44px; }
  .btn-compact{ height:44px; padding:0 1rem; }
}

/* ===== ã¾ã¨ã‚ãƒ‘ãƒãƒ« ===== */
.visually-hidden{
  position:absolute !important; width:1px; height:1px; padding:0; margin:-1px;
  overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
}
.summary-panel { background-color:#13807e; border-radius:12px; padding:16px; color:#fff; font-weight:bold; margin-bottom:20px; box-shadow:0 8px 24px rgba(0,0,0,0.08); }
.summary-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-bottom:12px; }
.summary-item { padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.4); }
.summary-item:last-child { border-bottom:none; }
.summary-item .summary-label { font-weight:700; font-size:1rem; margin-bottom:4px; }
.summary-item .summary-value { font-weight:900; font-size:1.6rem; }
.summary-subtitle { font-weight:700; font-size:1rem; margin:12px 0 6px; }
.summary-list { list-style:none; padding:0; margin:0; }
.summary-row { display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.4); }
.summary-row:last-child { border-bottom:none; }
.summary-row .row-label { font-size:1rem; }
.summary-row .row-value { font-size:1.3rem; font-weight:900; }
@media (max-width:720px){ .summary-grid{ grid-template-columns:1fr; } }

.savebar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px; }
.savebar input{ flex:1 1 240px; min-width:200px; padding:.6rem .8rem; border:1px solid #dfe8f2; border-radius:10px; background:#fff; }

.saved-compare{ margin-top:14px; }
.saved-wrap{ display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:10px; }

.saved-card{ background:#fff; border:1px solid #eef3f9; border-radius:12px; padding:12px; box-shadow:0 6px 18px rgba(15,48,87,.05); }
.saved-head{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
.saved-title{ font-weight:900; color:#0e2a47; font-size:1rem; }
.saved-meta{ color:#5f6f84; font-size:.8rem; }
.saved-kpis{ display:grid; grid-template-columns:1fr; gap:4px; margin-top:6px; }
.saved-kpis .row{ display:flex; justify-content:space-between; font-size:.95rem; }
.saved-actions{ display:flex; gap:8px; margin-top:8px; }
.btn-mini{ font-size:.85rem; padding:.4rem .6rem; border-radius:8px; }
.btn-danger{ background:#ffe8ec; border:1px solid #ffd0d8; color:#7a1026; }

/* â–¼ é‡‘åˆ©ãƒ—ãƒªã‚»ãƒƒãƒˆUIï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯æ’¤å»ï¼‰ */
.rate-presets{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px; }

/* è¿½åŠ ï¼šPCã ã‘æ¨ªä¸¦ã³ï¼ˆã‚»ãƒ¬ã‚¯ãƒˆ=å·¦ã«ã„ã£ã±ã„ã€ãƒœã‚¿ãƒ³=å³ï¼‰ */
@media (min-width: 768px){
  .rate-presets{
    display: grid;                 /* â† flex ã‹ã‚‰ grid ã«åˆ‡æ›¿ï¼ˆPCã®ã¿ï¼‰ */
    grid-template-columns: 1fr auto;
    align-items: center;
    gap: 8px;
  }
  .rate-presets select{
    width: 100%;                   /* ã‚»ãƒ¬ã‚¯ãƒˆã‚’æ¨ªã«åºƒã’ã‚‹ */
  }
}
.rate-section-title {
  font-size: 0.95rem;
  font-weight: 600;
  color: #555;
  margin: 0 0 6px 0;
  border-left: 4px solid #0c7e72;; /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆãƒ©ã‚¤ãƒ³ */
  padding-left: 6px;
}
.preset-title {
  margin-top: 16px; /* ä¸Šã«ä½™ç™½ã‚’è¿½åŠ  */
}    
/* ---------- ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ï¼ˆå…ƒåˆ©å‡ç­‰ / å…ƒé‡‘å‡ç­‰ï¼‰ã®ã‚«ã‚¹ã‚¿ãƒ  ---------- */
input[type="radio"] {
  appearance: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä¸¸ã½ã¡ã‚’æ¶ˆã™ */
  -webkit-appearance: none;
  -moz-appearance: none;
  width: 18px;
  height: 18px;
  border: 2px solid #0c7e72;
  border-radius: 50%;
  display: inline-block;
  position: relative;
  cursor: pointer;
  vertical-align: middle;
  transition: border-color 0.2s ease, background-color 0.2s ease;
  margin-right: 6px; /* ãƒ©ãƒ™ãƒ«ã¨ã®é–“éš” */
}

/* ãƒã‚§ãƒƒã‚¯æ™‚ã®ä¸­ã®ä¸¸ */
input[type="radio"]:checked::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 8px;
  height: 8px;
  background-color: #0c7e72;
  border-radius: 50%;
  transform: translate(-50%, -50%);
}

/* ãƒ›ãƒãƒ¼æ™‚ã«å°‘ã—æ¿ƒã */
input[type="radio"]:hover {
  border-color: #095e54;
}

/* ãƒ©ãƒ™ãƒ«ã®æ–‡å­—ã‚‚ã‚«ãƒ©ãƒ¼çµ±ä¸€ï¼ˆä»»æ„ï¼‰ */
input[type="radio"] + label {
  color: #0c7e72;
  font-weight: 500;
  cursor: pointer;
}

  </style>
</head>

<body onload="generateRateInputs()">
  <div class="title-wrap">
    <div class="subtitle">åŠå¹´ã”ã¨ã«é‡‘åˆ©ã‚’å¤‰æ›´ã§ãã‚‹</div>
    <h1 class="title">ä½å®…ãƒ­ãƒ¼ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
  </div>

  <!-- =============== æ¡ä»¶å…¥åŠ›ã‚«ãƒ¼ãƒ‰ =============== -->
  <div class="card">
    <div class="panel-title"><span class="chip">1</span>æ¡ä»¶</div>

    <!-- å€Ÿå…¥é¡ -->
    <div class="section-title">å€Ÿå…¥é¡ï¼ˆä¸‡å††ï¼‰</div>
    <input type="text" id="amount" value="3000" oninput="syncAmountFromText()" />
    <input type="range" id="amount-range" min="1000" max="10000" step="10" value="3000" oninput="syncAmountFromRange()" />
    <div class="range-labels"><span>1,000ä¸‡å††</span><span>2å„„å††</span></div>

    <!-- è¿”æ¸ˆæœŸé–“ -->
    <div class="section-title">è¿”æ¸ˆæœŸé–“ï¼ˆå¹´ï¼‰</div>
    <input type="number" id="years" value="35" oninput="syncYearsFromInput()" />
    <input type="range" id="years-range" min="1" max="50" step="1" value="35" oninput="syncYearsFromRange()" />
    <div class="range-labels"><span>1å¹´</span><span>50å¹´</span></div>

    <!-- è¿”æ¸ˆæ–¹å¼ -->
    <div class="section-title">è¿”æ¸ˆæ–¹å¼</div>
    <div class="inline-group">
      <label><input type="radio" name="repaymentType" value="principalAndInterestEqual" checked /> å…ƒåˆ©å‡ç­‰è¿”æ¸ˆ</label>
      <label><input type="radio" name="repaymentType" value="principalEqual" /> å…ƒé‡‘å‡ç­‰è¿”æ¸ˆ</label>
    </div>

    <!-- è«¸è²»ç”¨ -->
    <div class="section-title">è«¸è²»ç”¨ï¼ˆä¸‡å††ãƒ»ç¾é‡‘æ‰•ã„ï¼‰</div>
    <input type="text" id="miscCost" value="0" oninput="syncMiscFromText()" />

    <!-- é‡‘åˆ© -->
    <div class="section-title">é‡‘åˆ©ï¼ˆï¼…ï¼‰</div>

    <!-- é‡‘åˆ©ä¸€æ‹¬å…¥åŠ›ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
    <h3 class="rate-section-title">ä¸€æ‹¬è¨­å®š</h3>
    <div class="rate-toolbar">
      <div class="rate-field">
        <button type="button" class="icon-btn" aria-label="é‡‘åˆ©ã‚’0.05ä¸‹ã’ã‚‹" onclick="adjustRate(-0.05)">âˆ’</button>
        <input type="number" id="bulkRateUnified" class="rate-input bulk-rate-input" step="0.01" value="1.00" />
        <span class="rate-suffix">%</span>
        <button type="button" class="icon-btn" aria-label="é‡‘åˆ©ã‚’0.05ä¸Šã’ã‚‹" onclick="adjustRate(0.05)">ï¼‹</button>
      </div>
      <div class="scope-field"><select id="applyScope"></select></div>
      <button type="button" class="btn btn-compact" onclick="applyRateUnified()">é©ç”¨</button>
    </div>

    <!-- â–¼ é‡‘åˆ©ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç„¡ã—ï¼‰ -->
    <h3 class="rate-section-title preset-title">ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰è¨­å®š</h3>
<div class="rate-presets">
  <div class="scope-field">
    <select id="ratePreset">
      <option value="">é‡‘åˆ©ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é¸æŠ</option>
      <option value="flat10">æ¨ªã°ã„ 1.00%</option>
      <option value="patternA">ä½é‡‘åˆ©ã¨é«˜é‡‘åˆ©ã‚’ç¹°ã‚Šè¿”ã™ï¼ˆæœ€å¤§3.0%ï¼‰</option>
      <option value="patternB">ä½é‡‘åˆ©ã¨é«˜é‡‘åˆ©ã‚’ç¹°ã‚Šè¿”ã™ï¼ˆæœ€å¤§5.0%ï¼‰</option>
      <option value="stepUp025">æ®µéšçš„ä¸Šæ˜‡ï¼ˆæ¯å¹´+0.25% ä¸Šé™3%ï¼‰</option>
      <option value="earlyShock">æ—©æœŸã‚·ãƒ§ãƒƒã‚¯ï¼ˆ2å¹´ã§+1.50% â†’ æ¨ªã°ã„ï¼‰</option>
      <option value="ladderUp">éšæ®µä¸Šæ˜‡ï¼ˆ5å¹´ã”ã¨+0.5%ï¼‰</option>
    </select>
  </div>
  <button type="button" class="btn btn-compact" onclick="applyRatePreset()">é©ç”¨</button>
</div>

    <!-- åŠå¹´ã”ã¨ã®æ‰‹å…¥åŠ›æ¬„ï¼ˆå‹•çš„ç”Ÿæˆï¼‰ -->
    <div id="rate-inputs"></div>

    <!-- ãƒ‰ãƒ©ãƒƒã‚°ç·¨é›†ï¼ˆåŠå¹´ã”ã¨ï¼‰ -->
    <div class="section-title">ğŸ“ˆ ãƒ‰ãƒ©ãƒƒã‚°ã§é‡‘åˆ©ç·¨é›†ï¼ˆåŠå¹´ã”ã¨ï¼‰</div>
    <p class="note">ç‚¹ã‚’ä¸Šä¸‹ã«ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹ã ã‘ã§å¤‰æ›´ã§ãã¾ã™ã€‚å¤‰æ›´ã—ãŸãƒã‚¤ãƒ³ãƒˆä»¥é™ã¯åŒã˜é‡‘åˆ©ã¨ãªã‚Šã¾ã™ã€‚</p>
    <div class="chart-wrap"><canvas id="rateChart"></canvas></div>

    <div class="actions">
      <button class="btn btn-primary" onclick="simulate()">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹</button>
    </div>
  </div>

  <!-- =============== çµæœè¡¨ç¤ºã‚«ãƒ¼ãƒ‰ =============== -->
  <div class="card">
    <div class="panel-title"><span class="chip">2</span>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ</div>

    <!-- ã¾ã¨ã‚ãƒ‘ãƒãƒ« -->
    <section class="summary-panel" aria-label="ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã‚µãƒãƒªãƒ¼">
      <div class="summary-grid">
        <div class="summary-item primary">
          <div class="summary-label">ç·è¿”æ¸ˆé¡ï¼ˆè«¸è²»ç”¨å«ã‚€ï¼‰</div>
          <div class="summary-value" id="total-repay">â€”</div>
        </div>
        <div class="summary-item secondary">
          <div class="summary-label">ç·åˆ©æ¯</div>
          <div class="summary-value" id="total-interest">â€”</div>
        </div>
      </div>

      <h3 class="summary-subtitle">æœˆã€…è¿”æ¸ˆé¡</h3>
      <ul class="summary-list">
        <li class="summary-row"><span class="row-label">åˆæœˆ</span><strong class="row-value" id="kpi-first">â€”</strong></li>
        <li class="summary-row"><span class="row-label">å¹³å‡</span><strong class="row-value" id="kpi-avg">â€”</strong></li>
        <li class="summary-row"><span class="row-label">æœ€å¤§</span><strong class="row-value" id="kpi-max">â€”</strong></li>
      </ul>
    </section>

    <!-- ã‚°ãƒ©ãƒ• -->
    <div class="chart-block">
      <div class="chart-title">æœˆã€…ã®æ”¯æ‰•é¡</div>
      <div class="chart-wrap"><canvas id="paymentChart"></canvas></div>
    </div>
    <div class="chart-block">
      <div class="chart-title">æ”¯æ‰•å†…è¨³ï¼ˆå…ƒé‡‘/åˆ©æ¯ï¼‰</div>
      <div class="chart-wrap"><canvas id="stackedChart"></canvas></div>
    </div>

    <!-- æ˜ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆON/OFFï¼‰ -->
    <div class="row-end">
      <label class="hint"><input type="checkbox" id="toggle-table"> æ˜ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ç¤º</label>
      <span class="hint">â€»ã‚ªãƒ•ã«ã™ã‚‹ã¨è»½ããªã‚Šã¾ã™</span>
    </div>
    <div id="repayment-table"></div>

    <!-- Excelå‡ºåŠ› -->
    <div class="actions">
      <button class="btn btn-ghost" onclick="downloadExcel()">ğŸ“¥ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã‚’Excelã§ä¿å­˜</button>
    </div>

    <!-- äº’æ›ç”¨ -->
    <div id="result" class="visually-hidden" aria-hidden="true"></div>
  </div>

  <!-- â–¼ ä¿å­˜ãƒ»æ¯”è¼ƒ -->
  <!-- è¦‹å‡ºã—ã‚’è¿½åŠ ï¼ˆâ‘ â‘¡ã¨åŒã˜ panel-title ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ -->
  <div class="panel-title panel-title-save"><span class="chip">3</span>çµæœã‚’ä¿å­˜ãƒ»æ¯”è¼ƒ</div>
  <div class="savebar">
    <input type="text" id="saveLabel" placeholder="ã‚·ãƒŠãƒªã‚ªåï¼ˆä¾‹ï¼šé ­é‡‘500 / 35å¹´ï¼‰">
    <button type="button" class="btn btn-compact" onclick="saveCurrentSummary()">çµæœã‚’ä¿å­˜</button>
    <button type="button" class="btn btn-ghost" onclick="exportSavedSummaries()">ğŸ“¥ æ¯”è¼ƒçµæœã‚’Excelã§ä¿å­˜</button>
  </div>
  <div class="card saved-compare" id="savedCompare" style="display:none;">
    <div class="saved-wrap" id="savedList"></div>
  </div>

<script>

/* ---------------- ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ ---------------- */
let lastSimData = [], rateChartInstance = null, paymentChart = null, stackedChart = null;
let lastTotals = null; // â† è¿½åŠ ï¼šæœªä¸¸ã‚ã®åˆè¨ˆï¼ˆç·å…ƒé‡‘ãƒ»ç·åˆ©æ¯ãƒ»æ”¯æ‰•é…åˆ—ï¼‰ã‚’ä¿æŒ
let simTimer = null;   // â† è¿½åŠ ï¼šæ‰‹å…¥åŠ›æ™‚ã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹ç”¨ã‚¿ã‚¤ãƒãƒ¼

/* ---------------- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---------------- */
function parseAmount(v){ return parseFloat(v.replace(/,/g,''))*10000; }

/* ---------------- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼šãƒ‡ãƒã‚¦ãƒ³ã‚¹å®Ÿè¡Œ ---------------- */
function triggerSimulateDebounced(ms=250){
  if(simTimer) clearTimeout(simTimer);
  simTimer = setTimeout(()=>simulate(), ms);
}  
  
/* ---------------- å…¥åŠ›åŒæœŸï¼ˆå€Ÿå…¥é¡ãƒ»å¹´æ•°ï¼‰ ---------------- */
function syncAmountFromRange(){ 
  const v=+document.getElementById('amount-range').value; 
  document.getElementById('amount').value=v.toLocaleString(); 
}
function syncAmountFromText(){ 
  const raw=document.getElementById('amount').value.replace(/[^\d]/g,''); 
  const n=parseInt(raw||'0'); 
  document.getElementById('amount-range').value=n; 
  document.getElementById('amount').value=n.toLocaleString(); 
}
function syncMiscFromText(){
  const raw = document.getElementById('miscCost').value.replace(/[^\d]/g,'');
  const n = parseInt(raw||'0',10);
  document.getElementById('miscCost').value = n.toLocaleString();
}
function syncYearsFromRange(){ 
  const v=+document.getElementById('years-range').value; 
  document.getElementById('years').value=v; 
  generateRateInputs();
}
function syncYearsFromInput(){ 
  const v=+document.getElementById('years').value; 
  document.getElementById('years-range').value=v; 
  generateRateInputs();
}

/* ---------------- é‡‘åˆ©å…¥åŠ›æ¬„ã®ç”Ÿæˆ ---------------- */
function generateRateInputs(){
  const container=document.getElementById('rate-inputs'); 
  container.innerHTML='';
  const years=+document.getElementById('years').value;

  // é©ç”¨ç¯„å›²ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³
  const scope=document.getElementById('applyScope'); 
  scope.innerHTML='';
  const optAll=document.createElement('option'); 
  optAll.value='all'; optAll.textContent='å…¨æœŸé–“'; 
  scope.appendChild(optAll);
  for(let y=2;y<=years;y++){
    const o=document.createElement('option'); 
    o.value=String(y); 
    o.textContent=`${y}å¹´ç›®ä»¥é™`; 
    scope.appendChild(o); 
  }

  // â–¼ è¿½åŠ ï¼šè¦‹å‡ºã—è¡Œï¼ˆå‰åŠ/å¾ŒåŠï¼‰
  const head = document.createElement('div');
  head.className = 'rate-input-head';
  const stub = document.createElement('span');  // å·¦ç«¯ï¼šå¹´ãƒ©ãƒ™ãƒ«ã¨å¹…ã‚’åˆã‚ã›ã‚‹ãƒ€ãƒŸãƒ¼
  stub.className = 'col-year';
  const h1 = document.createElement('span'); h1.className = 'col-half'; h1.textContent = 'å‰åŠ';
  const h2 = document.createElement('span'); h2.className = 'col-half'; h2.textContent = 'å¾ŒåŠ';
  head.append(stub, h1, h2);
  container.appendChild(head);
  
  // åŠå¹´ã”ã¨å…¥åŠ›
  for(let y=1;y<=years;y++){
    const row=document.createElement('div'); 
    row.className='rate-input-row';
    const label=document.createElement('span'); 
    label.textContent=`${y}å¹´ç›®`;

    const input1=document.createElement('input'); 
    const input2=document.createElement('input');

    [input1,input2].forEach((inp,i)=>{
      inp.type='number'; 
      inp.step='0.01'; 
      inp.value='1.00';
      inp.className='rate-input half-rate-input';
      inp.dataset.index=(y-1)*2+i;
      inp.addEventListener('input',updateRateChartFromInputs);
    });

    row.appendChild(label); 
    row.appendChild(input1); 
    row.appendChild(input2); 
    container.appendChild(row);
  }

  // åˆæœŸæç”»
  drawRateChart();
}

/* ---------------- å…¥åŠ›æ¬„ â†’ ã‚°ãƒ©ãƒ•æ›´æ–° ---------------- */
function updateRateChartFromInputs(){
  const inputs=[...document.querySelectorAll('.half-rate-input')];
  const rates=inputs.map(el=>parseFloat(el.value)||0);
  if(rateChartInstance){
    rateChartInstance.data.labels=rates.map((_,i)=>`${Math.floor(i/2)+1}å¹´ç›®`);
    rateChartInstance.data.datasets[0].data=rates;

    const dataMax = Math.max(...rates, 0);
    const yMax = Math.max(5, Math.ceil(dataMax / 0.5) * 0.5);
    rateChartInstance.options.scales.y.max = yMax;

    rateChartInstance.update();
  }
  // â† è¿½åŠ ï¼šæ‰‹å…¥åŠ›æ›´æ–°æ™‚ã¯ãƒ‡ãƒã‚¦ãƒ³ã‚¹ã§è‡ªå‹•å†è¨ˆç®—
  triggerSimulateDebounced(250);
}

/* ---------------- ã‚°ãƒ©ãƒ• â†’ å…¥åŠ›æ¬„æ›´æ–° ---------------- */
function updateInputsFromRateChart(rates){
  const inputs=document.querySelectorAll('.half-rate-input');
  rates.forEach((r,i)=>{ if(inputs[i]) inputs[i].value=Number(r).toFixed(2); });
  simulate();
}

/* ---------------- ä¸€æ‹¬é‡‘åˆ©å…¥åŠ›ï¼ˆÂ±ã¨é©ç”¨ï¼‰ ---------------- */
function clamp06(v){ return Math.max(0, Math.min(10, v)); }
function adjustRate(delta){
  const el=document.getElementById('bulkRateUnified');
  let v=parseFloat(el.value||'0'); 
  v = clamp06( Math.round((v+delta)*100)/100 ); 
  el.value=v.toFixed(2);
}
function applyRateUnified(){
  const rate=parseFloat(document.getElementById('bulkRateUnified').value);
  if(isNaN(rate)) return alert('æœ‰åŠ¹ãªé‡‘åˆ©ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
  const scopeVal=document.getElementById('applyScope').value;
  const inputs=[...document.querySelectorAll('.half-rate-input')];

  if(scopeVal==='all'){ 
    inputs.forEach(inp=>inp.value=rate.toFixed(2)); 
  }else{
    const fromYear=parseInt(scopeVal,10);
    const start=(fromYear-1)*2;
    for(let i=start;i<inputs.length;i++) inputs[i].value=rate.toFixed(2);
  }
  updateRateChartFromInputs();
  // â† è¿½åŠ ï¼šé©ç”¨ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã¯å³æ™‚ã«å†è¨ˆç®—
simulate();
}

/* ---------------- é‡‘åˆ©ã‚°ãƒ©ãƒ•ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ç·¨é›†ï¼‰ ---------------- */
function drawRateChart(){
  const inputs=[...document.querySelectorAll('.half-rate-input')];
  const rates=inputs.map(el=>parseFloat(el.value)||0);

  const dataMax = Math.max(...rates, 0);
  const yMax = Math.max(5, Math.ceil(dataMax / 0.5) * 0.5);

  const ctx=document.getElementById('rateChart').getContext('2d');
  if(rateChartInstance) rateChartInstance.destroy();

  rateChartInstance=new Chart(ctx,{
    type:'line',
    data:{ 
      labels:rates.map((_,i)=>`${Math.floor(i/2)+1}å¹´ç›®`),
      datasets:[{ 
        label:'åŠå¹´ã”ã¨ã®é‡‘åˆ©ï¼ˆï¼…ï¼‰', 
        data:rates, 
        borderColor:'#0c7e86', 
        backgroundColor:'rgba(12,126,134,0.12)',
        pointRadius:4, pointHoverRadius:8, pointHitRadius:20, 
        pointStyle:'rectRounded', borderWidth:3, tension:.2 
      }]
    },
    options:{
      responsive:true, maintainAspectRatio:false, animation:false,
      scales:{
        x:{ 
          grid:{display:false}, 
          title:{display:true,text:'ä½•å¹´ç›®',color:'#0e2a47',font:{weight:'bold'}},
          ticks:{ autoSkip:false, maxRotation:0, font:{size:13}, callback:(v,i)=> i%2===1 ? (Math.floor(i/2)+1) : '' }
        },
        y:{ 
          beginAtZero:true, min:0, max:yMax,
          grid:{color:'rgba(0,0,0,.08)'},
          ticks:{ stepSize:.5, font:{size:13}, callback:v=>Number(v).toFixed(1)+'%' } 
        }
      },
      plugins:{
        legend:{display:false},
        tooltip:{ 
          backgroundColor:'#0e2a47', titleColor:'#fff', bodyColor:'#fff',
          callbacks:{ 
            title:(items)=>{ const i=items[0].dataIndex; return `${Math.floor(i/2)+1}å¹´ç›®ï¼ˆ${i%2===0?'å‰åŠ':'å¾ŒåŠ'}ï¼‰`;},
            label:(ctx)=>`é‡‘åˆ©: ${Number(ctx.parsed.y).toFixed(2)}%` 
          } 
        },
        dragData:{
          round:2, showTooltip:true, dragX:false, dragY:true,
          onDrag:(e,di,idx,val)=>{ const snapped=Math.round(val/0.05)*0.05; return Math.max(0,Math.min(6,snapped)); },
          onDragStart:(e)=>{ if(e&&e.native&&e.native.preventDefault) e.native.preventDefault(); document.body.style.touchAction='none'; },
          onDragEnd:(e,di,index,value)=>{
            document.body.style.touchAction='auto';
            const old=rateChartInstance.data.datasets[0].data, newRates=[...old], len=newRates.length, PRE=0;
            for(let i=index;i<len;i++) newRates[i]=value;
            const start=Math.max(0,index-PRE), span=index-start;
            if(span>0){ 
              for(let i=start;i<index;i++){ 
                const t=(i-start+1)/span; 
                newRates[i]=old[i]*(1-t)+value*t; 
              } 
            }
            updateInputsFromRateChart(newRates);
            const dataMax = Math.max(...newRates, 0);
            const yMax = Math.max(5, Math.ceil(dataMax / 0.5) * 0.5);
            rateChartInstance.options.scales.y.max = yMax;
            rateChartInstance.data.datasets[0].data=newRates;
            rateChartInstance.update();
          }
        }
      }
    },
    plugins:[Chart.registry.getPlugin('dragdata')]
  });
}

/* ---------------- è¿”æ¸ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœ¬ä½“ ---------------- */
function simulate(){
  const amount=parseAmount(document.getElementById('amount').value);
  const years=+document.getElementById('years').value, months=years*12;
  const repaymentType=document.querySelector("input[name='repaymentType']:checked").value;
  const rates=[...document.querySelectorAll('.half-rate-input')].map(el=>parseFloat(el.value)/100);
  if(!amount||!years) return alert('å€Ÿå…¥é¡ã¨è¿”æ¸ˆæœŸé–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
  if(rates.length<Math.ceil(months/6)) return alert('é‡‘åˆ©ã®å…¥åŠ›ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚');

  let balance=amount; 
  const result=[], payments=[]; 
  let totalP=0,totalI=0;

  for(let m=0;m<months;m++){
    const r=(rates[Math.floor(m/6)]||0)/12, remain=months-m;
    let interest=balance*r, principal, out;
    if(repaymentType==='principalAndInterestEqual'){
      out = r>0 ? balance*r*Math.pow(1+r,remain)/(Math.pow(1+r,remain)-1) : balance/remain;
      interest=balance*r; principal=out-interest;
    }else{
      principal=amount/months; interest=balance*r; out=principal+interest;
    }
    balance-=principal; if(balance<0) balance=0; 
    totalP+=principal; totalI+=interest; 
    payments.push(out);

    result.push({ 
      æœˆ:m+1, å…ƒé‡‘:Math.round(principal), åˆ©æ¯:Math.round(interest), æ®‹é«˜:Math.round(balance), æ”¯æ‰•é¡:Math.round(out)
    });
  }

  lastSimData=result; 
lastTotals = { totalP, totalI, payments };
displayResult(result,totalP,totalI,payments); 
  drawCharts(result);
}

/* ---------------- çµæœè¡¨ç¤ºï¼ˆKPI/ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ ---------------- */
function displayResult(data,totalP,totalI,payments){
  const misc = parseAmount(document.getElementById('miscCost')?.value || '0');
  const totalRepay = Math.ceil(totalP + totalI + misc);
  const interestRounded = Math.ceil(totalI);

  const first=Math.round(payments[0]||0);
  const avg=Math.round((payments.reduce((a,b)=>a+b,0)/payments.length)||0);
  const max=Math.round(Math.max(...payments,0));

  const elRepay = document.getElementById('total-repay');
  const elInterest = document.getElementById('total-interest');
  const elFirst = document.getElementById('kpi-first');
  const elAvg = document.getElementById('kpi-avg');
  const elMax = document.getElementById('kpi-max');

  if(elRepay)   elRepay.textContent   = `${totalRepay.toLocaleString()} å††`;
  if(elInterest)elInterest.textContent= `${interestRounded.toLocaleString()} å††`;
  if(elFirst)   elFirst.textContent   = `${first.toLocaleString()} å††`;
  if(elAvg)     elAvg.textContent     = `${avg.toLocaleString()} å††`;
  if(elMax)     elMax.textContent     = `${max.toLocaleString()} å††`;

  const legacy = document.getElementById('result');
  if(legacy){
    legacy.textContent = `ğŸ ç·è¿”æ¸ˆé¡ï¼ˆè«¸è²»ç”¨å«ã‚€ï¼‰: ${totalRepay.toLocaleString()} å††\nğŸ“Š ç·åˆ©æ¯: ${interestRounded.toLocaleString()} å††`;
  }

  const show=document.getElementById('toggle-table').checked;
  const wrap=document.getElementById('repayment-table');
  wrap.innerHTML='';
  if(show){
    const table=document.createElement('table'), thead=table.createTHead(), tbody=table.createTBody();
    thead.innerHTML='<tr><th>æœˆ</th><th>å…ƒé‡‘</th><th>åˆ©æ¯</th><th>æ”¯æ‰•é¡</th><th>æ®‹é«˜</th></tr>';
    for(const row of data){
      const tr=tbody.insertRow();
      for(const k of ['æœˆ','å…ƒé‡‘','åˆ©æ¯','æ”¯æ‰•é¡','æ®‹é«˜']){
        const td=tr.insertCell();
        td.textContent=row[k].toLocaleString();
        td.style.textAlign='right';
      }
    }
    wrap.appendChild(table);
  }
}

/* ---------------- ã‚°ãƒ©ãƒ•æç”»ï¼ˆæ”¯æ‰•é¡/å†…è¨³ï¼‰ ---------------- */
function drawCharts(data){
  const labels=data.map(d=>d['æœˆ']), 
        principal=data.map(d=>d['å…ƒé‡‘']), 
        interest=data.map(d=>d['åˆ©æ¯']), 
        payment=data.map(d=>d['æ”¯æ‰•é¡']);

  if(paymentChart) paymentChart.destroy(); 
  if(stackedChart) stackedChart.destroy();

  const axisFont = { size:13 },
        common = {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          scales: {
            x: {
              title: { display: true, text: 'ä½•å¹´ç›®', color: '#0e2a47', font: { weight: 'bold' } },
              ticks: {
                maxRotation: 0,
                autoSkip: false,
                font: axisFont,
                callback: (value, index) => (index % 12 === 0) ? (Math.floor(index / 12) + 1) : ''
              },
              grid: { display: false }
            },
            y: { ticks: { font: axisFont }, grid: { color: 'rgba(0,0,0,.08)' }, beginAtZero: true, min: 0 }
          },
          plugins: { legend: { display: false } }
        };

  paymentChart=new Chart(document.getElementById('paymentChart').getContext('2d'),{
    type:'bar', 
    data:{labels,datasets:[{label:'æœˆã€…ã®æ”¯æ‰•é¡',data:payment,backgroundColor:'#0c7e86'}]}, 
    options:common 
  });

  stackedChart=new Chart(document.getElementById('stackedChart').getContext('2d'),{
    type:'bar', 
    data:{labels,datasets:[
      {label:'å…ƒé‡‘',data:principal,backgroundColor:'#0c7e86'},
      {label:'åˆ©æ¯',data:interest,backgroundColor:'#ffbf3a'}
    ]},
    options:{...common, scales:{...common.scales, x:{...common.scales.x,stacked:true}, y:{...common.scales.y,stacked:true}}} 
  });
}

/* ---------------- Excelå‡ºåŠ› ---------------- */
function downloadExcel(){
  if(!lastSimData.length) return alert('ã¾ãšã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
  const ws=XLSX.utils.json_to_sheet(lastSimData), wb=XLSX.utils.book_new(); 
  XLSX.utils.book_append_sheet(wb,ws,'è¿”æ¸ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³'); 
  XLSX.writeFile(wb,'loan_simulation.xlsx');
}

/* ---------------- æ˜ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ON/OFF ---------------- */
document.addEventListener('change', e => {
  if (e.target && e.target.id === 'toggle-table' && lastSimData.length) {
    // ä¸¸ã‚æ¸ˆã¿æ˜ç´°ã‹ã‚‰å†é›†è¨ˆã›ãšã€æœªä¸¸ã‚ã®åˆè¨ˆã‚’ä½¿ã£ã¦æç”»
    const fallbackPays = lastSimData.map(r => r['æ”¯æ‰•é¡']);
    const { totalP, totalI, payments } = lastTotals || { totalP: 0, totalI: 0, payments: fallbackPays };
    displayResult(lastSimData, totalP, totalI, payments);
  }
});

/* ====== ä¸€æ™‚ä¿å­˜ï¼ˆæ¯”è¼ƒï¼‰æ©Ÿèƒ½ ====== */
let savedSummaries = [];
function parseYenText(text){ return parseInt(String(text||'').replace(/[^\d]/g,''),10) || 0; }
function saveCurrentSummary(){
  const total = document.getElementById('total-repay')?.textContent || '';
  const interest = document.getElementById('total-interest')?.textContent || '';
  const first = document.getElementById('kpi-first')?.textContent || '';
  const avg = document.getElementById('kpi-avg')?.textContent || '';
  const max = document.getElementById('kpi-max')?.textContent || '';
  if(!total || !interest || !first || !avg || !max){ alert('ã¾ãšã€Œã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚'); return; }
  const label = (document.getElementById('saveLabel')?.value || '').trim() || `ã‚·ãƒŠãƒªã‚ª${savedSummaries.length+1}`;
  const now = new Date();
  const item = {
    id: Date.now(),
    label,
    savedAt: now.toLocaleString(),
    totalRepay: parseYenText(total),
    totalInterest: parseYenText(interest),
    first: parseYenText(first),
    avg: parseYenText(avg),
    max: parseYenText(max)
  };
  savedSummaries.push(item);
  (document.getElementById('saveLabel')||{}).value = '';
  renderSavedSummaries();
}
function renderSavedSummaries(){
  const box = document.getElementById('savedCompare');
  const list = document.getElementById('savedList');
  if(!box || !list) return;
  if(savedSummaries.length===0){ box.style.display='none'; list.innerHTML=''; return; }
  box.style.display='block';
  list.innerHTML = savedSummaries.map(s => `
    <div class="saved-card">
      <div class="saved-head">
        <div>
          <div class="saved-title">${escapeHtml(s.label)}</div>
          <div class="saved-meta">${escapeHtml(s.savedAt)}</div>
        </div>
      </div>
      <div class="saved-kpis">
        <div class="row"><span>ç·è¿”æ¸ˆé¡ï¼ˆè«¸è²»ç”¨å«ã‚€ï¼‰</span><strong>${s.totalRepay.toLocaleString()} å††</strong></div>
        <div class="row"><span>ç·åˆ©æ¯</span><strong>${s.totalInterest.toLocaleString()} å††</strong></div>
        <div class="row"><span>åˆæœˆ</span><strong>${s.first.toLocaleString()} å††</strong></div>
        <div class="row"><span>å¹³å‡</span><strong>${s.avg.toLocaleString()} å††</strong></div>
        <div class="row"><span>æœ€å¤§</span><strong>${s.max.toLocaleString()} å††</strong></div>
      </div>
      <div class="saved-actions">
        <button class="btn btn-mini btn-ghost" onclick="renameSaved(${s.id})">åç§°å¤‰æ›´</button>
        <button class="btn btn-mini btn-danger" onclick="deleteSaved(${s.id})">å‰Šé™¤</button>
      </div>
    </div>
  `).join('');
}
function deleteSaved(id){ savedSummaries = savedSummaries.filter(s => s.id !== id); renderSavedSummaries(); }
function renameSaved(id){
  const target = savedSummaries.find(s => s.id === id);
  if(!target) return;
  const name = prompt('ã‚·ãƒŠãƒªã‚ªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š', target.label);
  if(name!==null){ target.label = name.trim() || target.label; renderSavedSummaries(); }
}
function exportSavedSummaries(){
  if(!savedSummaries.length){ alert('ä¿å­˜ã•ã‚ŒãŸçµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); return; }
  if(typeof XLSX === 'undefined'){ alert('XLSXãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'); return; }
  const rows = savedSummaries.map(s => ({
    ã‚·ãƒŠãƒªã‚ªå: s.label, ä¿å­˜æ—¥æ™‚: s.savedAt, ç·è¿”æ¸ˆé¡: s.totalRepay, ç·åˆ©æ¯: s.totalInterest,
    åˆæœˆ: s.first, å¹³å‡: s.avg, æœ€å¤§: s.max
  }));
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'æ¯”è¼ƒçµæœ');
  XLSX.writeFile(wb, 'loan_sim_comparison.xlsx');
}
function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])); }

/* ========= é‡‘åˆ©ãƒ—ãƒªã‚»ãƒƒãƒˆï¼šç”Ÿæˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */
// åŠå¹´ã”ã¨ã®é…åˆ—ã‚’å…¥åŠ›æ¬„ï¼†ã‚°ãƒ©ãƒ•ã¸åæ˜ 
function setHalfYearRates(rates){
  const inputs = [...document.querySelectorAll('.half-rate-input')];
  const need = inputs.length;
  if(!need) return;
  const arr = rates.slice(0, need);
  while(arr.length < need) arr.push(arr[arr.length-1] ?? 1.00);
  arr.forEach((v,i)=>{ inputs[i].value = Number(v).toFixed(2); });
  updateRateChartFromInputs();
  // â† è¿½åŠ ï¼šãƒ—ãƒªã‚»ãƒƒãƒˆé©ç”¨æ™‚ã‚‚å³æ™‚ã«å†è¨ˆç®—
simulate();
}
// å¹´é…åˆ— â†’ åŠå¹´é…åˆ—ã«å±•é–‹
function expandYearToHalf(yearRates){ const out=[]; for(const y of yearRates){ out.push(y,y); } return out; }
// è¿”æ¸ˆå¹´æ•°
function halfLen(){ return (+document.getElementById('years').value)*2; }
// ç·šå½¢ã«å¹´æ¬¡å¤‰åŒ–
function genLinearYears(start, deltaPerYear, clampMin=0, clampMax=6, years=+document.getElementById('years').value){
  const arr=[]; let cur=start;
  for(let y=0;y<years;y++){
    if(y>0) cur = Math.min(clampMax, Math.max(clampMin, cur+deltaPerYear));
    arr.push(Number(cur.toFixed(2)));
  }
  return arr;
}
// éšæ®µä¸Šæ˜‡
function genLadderYears(start, step, spanYears, max=6, years=+document.getElementById('years').value){
  const arr=[]; let cur=start;
  for(let y=0;y<years;y++){
    if(y>0 && y%spanYears===0) cur = Math.min(max, cur+step);
    arr.push(Number(cur.toFixed(2)));
  }
  return arr;
}
// åˆæœŸã‚·ãƒ§ãƒƒã‚¯ â†’ æ¨ªã°ã„
function genEarlyShockYears(start, shockUp, shockYears=2, max=6, years=+document.getElementById('years').value){
  const arr=[]; let cur=start;
  for(let y=0;y<years;y++){
    if(y<shockYears) cur = Math.min(max, (start + (shockUp/shockYears)*(y+1)));
    else cur = Math.min(max, start + shockUp);
    arr.push(Number(cur.toFixed(2)));
  }
  return arr;
}
// 35å¹´åˆ†ã®åŠæœŸé‡‘åˆ©ï¼ˆï¼…ï¼‰
const PRESET_HALF_RATES_PATTERN_A = [
  1.00,1.00, 1.25,1.25, 1.50,1.50, 2.00,2.50, 3.00,3.00,
  3.00,2.50, 2.00,1.50, 1.50,1.25, 1.25,1.00, 1.00,1.00,
  1.00,1.00, 1.25,1.25, 1.50,1.50, 2.00,2.50, 3.00,3.00,
  3.00,2.50, 2.00,1.50, 1.50,1.25, 1.25,1.00, 1.00,1.00,
  1.00,1.00, 1.25,1.25, 1.50,1.50, 2.00,2.50, 3.00,3.00,
  3.00,2.50, 2.00,1.50, 1.50,1.25, 1.25,1.00, 1.00,1.00,
  1.00,1.00, 1.25,1.25, 1.50,1.50, 2.00,2.50, 3.00,3.00
];

// 35å¹´åˆ†ã®åŠæœŸé‡‘åˆ©ï¼ˆï¼…ï¼‰
const PRESET_HALF_RATES_PATTERN_B = [
  1.00,1.00, 1.25,1.25, 1.50,1.50, 2.00,2.50, 5.00,5.00,
  5.00,2.50, 2.00,1.50, 1.50,1.25, 1.25,1.00, 1.00,1.00,
  1.00,1.00, 1.25,1.25, 1.50,1.50, 2.00,2.50, 5.00,5.00,
  5.00,2.50, 2.00,1.50, 1.50,1.25, 1.25,1.00, 1.00,1.00,
  1.00,1.00, 1.25,1.25, 1.50,1.50, 2.00,2.50, 5.00,5.00,
  5.00,2.50, 2.00,1.50, 1.50,1.25, 1.25,1.00, 1.00,1.00,
  1.00,1.00, 1.25,1.25, 1.50,1.50, 2.00,2.50, 5.00,5.00
];  
/* ========= ãƒ—ãƒªã‚»ãƒƒãƒˆé©ç”¨ ========= */
function applyRatePreset(){
  const key = document.getElementById('ratePreset').value;
  if(!key) return;
  const years = +document.getElementById('years').value;

  let yearRates=[];
  switch(key){
    case 'flat10':      yearRates = Array.from({length:years}, _=>1.00); break;
    case 'stepUp025':   yearRates = genLinearYears(1.00, +0.25, 0, 3.00, years); break;
    case 'earlyShock':  yearRates = genEarlyShockYears(1.00, 1.50, 2, 6, years); break;
    case 'ladderUp':    yearRates = genLadderYears(1.00, 0.50, 5, 6, years); break;
    case 'patternA': {
      const need = (+document.getElementById('years').value) * 2;
      const base = PRESET_HALF_RATES_PATTERN_A;
      const halfRates = base.slice(0, need);
      while (halfRates.length < need) halfRates.push(base[base.length - 1]);
      setHalfYearRates(halfRates);
      return;
    }
      case 'patternB': {
      const need = (+document.getElementById('years').value) * 2;
      const base = PRESET_HALF_RATES_PATTERN_B;
      const halfRates = base.slice(0, need);
      while (halfRates.length < need) halfRates.push(base[base.length - 1]);
      setHalfYearRates(halfRates);
      return;
    }
  }

  const halfRates = expandYearToHalf(yearRates);
  setHalfYearRates(halfRates);
}
</script>
</body>
</html>
